name: Build Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.1.0)'
        required: true
        default: 'v0.1.0'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main

    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
      with:
        shared-key: "release-cache"

    - name: Build eBPF program
      run: nix develop --command cargo xtask build-ebpf --release

    - name: Build release package (static binary with musl)
      run: nix develop --command cargo build --release --target x86_64-unknown-linux-musl --package wg-ondemand

    - name: Determine version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: Create release directory structure
      run: |
        VERSION=${{ steps.version.outputs.VERSION }}
        RELEASE_DIR="wg-ondemand-${VERSION}"
        mkdir -p ${RELEASE_DIR}/{bin,scripts,config,systemd,docs}

        # Copy binaries from cargo build (musl static binary)
        cp target/x86_64-unknown-linux-musl/release/wg-ondemand ${RELEASE_DIR}/bin/
        cp scripts/setup-tc.sh ${RELEASE_DIR}/bin/wg-ondemand-setup-tc
        cp scripts/wg-ondemand-ctl ${RELEASE_DIR}/bin/wg-ondemand-ctl
        chmod +x ${RELEASE_DIR}/bin/*

        # Copy scripts
        cp scripts/install.sh ${RELEASE_DIR}/
        cp scripts/uninstall.sh ${RELEASE_DIR}/
        chmod +x ${RELEASE_DIR}/*.sh

        # Copy config
        cp config/wg-ondemand.toml ${RELEASE_DIR}/config/wg-ondemand.toml.example

        # Copy systemd service
        cp systemd/wg-ondemand.service ${RELEASE_DIR}/systemd/

        # Copy documentation
        cp README.md ${RELEASE_DIR}/docs/
        cp docs/*.md ${RELEASE_DIR}/docs/

        # Create installation README
        cat > ${RELEASE_DIR}/INSTALL.md << 'EOF'
        # WireGuard On-Demand Installation

        ## Quick Install

        ```bash
        # Extract the archive
        tar xzf wg-ondemand-*.tar.gz
        cd wg-ondemand-*/

        # Run the installer (requires sudo)
        sudo ./install.sh

        # Edit the configuration
        sudo nano /etc/wg-ondemand/config.toml

        # Enable and start the service
        sudo systemctl enable wg-ondemand
        sudo systemctl start wg-ondemand

        # Check status
        sudo systemctl status wg-ondemand
        ```

        ## Configuration

        Edit `/etc/wg-ondemand/config.toml` and set:

        - `target_ssid`: Your hotspot SSID (e.g., "MyPhoneHotspot")
        - `wg_interface`: Your WireGuard interface name (e.g., "wg0")
        - `nm_connection`: NetworkManager connection name (if using NetworkManager)
        - `monitor_interface`: Network interface to monitor (optional, auto-detects if not set)
        - `ranges`: Target subnets that trigger VPN activation (e.g., ["192.168.1.0/24"])

        ## Requirements

        - Linux kernel 5.8 or newer
        - NetworkManager (for SSID monitoring)
        - WireGuard installed and configured
        - Root/sudo access

        ## Uninstall

        ```bash
        cd wg-ondemand-*/
        sudo ./uninstall.sh
        ```

        ## Documentation

        See `docs/README.md` for full documentation.
        EOF

        # Create checksums
        cd ${RELEASE_DIR}
        find . -type f -exec sha256sum {} \; > SHA256SUMS
        cd ..

        # Create tarball
        tar czf ${RELEASE_DIR}.tar.gz ${RELEASE_DIR}

        # Create checksum for tarball
        sha256sum ${RELEASE_DIR}.tar.gz > ${RELEASE_DIR}.tar.gz.sha256

    - name: Build Debian package
      run: |
        VERSION=${{ steps.version.outputs.VERSION }}
        VERSION_NO_V=${VERSION#v}
        DEB_DIR="wg-ondemand_${VERSION_NO_V}_amd64"

        # Create Debian package structure
        mkdir -p ${DEB_DIR}/DEBIAN
        mkdir -p ${DEB_DIR}/usr/bin
        mkdir -p ${DEB_DIR}/usr/lib/systemd/system
        mkdir -p ${DEB_DIR}/etc/wg-ondemand
        mkdir -p ${DEB_DIR}/usr/share/doc/wg-ondemand

        # Copy binary (static musl binary)
        cp target/x86_64-unknown-linux-musl/release/wg-ondemand ${DEB_DIR}/usr/bin/
        cp scripts/setup-tc.sh ${DEB_DIR}/usr/bin/wg-ondemand-setup-tc
        cp scripts/wg-ondemand-ctl ${DEB_DIR}/usr/bin/wg-ondemand-ctl
        chmod +x ${DEB_DIR}/usr/bin/*

        # Copy systemd service
        cp systemd/wg-ondemand.service ${DEB_DIR}/usr/lib/systemd/system/

        # Copy config example
        cp config/wg-ondemand.toml ${DEB_DIR}/etc/wg-ondemand/wg-ondemand.toml.example

        # Copy documentation
        cp README.md ${DEB_DIR}/usr/share/doc/wg-ondemand/
        cp docs/*.md ${DEB_DIR}/usr/share/doc/wg-ondemand/ 2>/dev/null || true

        # Create control file
        cat > ${DEB_DIR}/DEBIAN/control << EOF
        Package: wg-ondemand
        Version: ${VERSION_NO_V}
        Section: net
        Priority: optional
        Architecture: amd64
        Depends: wireguard-tools, network-manager
        Maintainer: wg-ondemand developers <noreply@github.com>
        Description: Automatic WireGuard VPN activation on-demand
         A lightweight daemon that automatically activates your WireGuard VPN tunnel
         only when accessing specific networks, saving mobile data and battery life.
         .
         Features:
          - Automatic VPN activation based on traffic detection
          - SSID-aware (only works on specific WiFi networks)
          - Automatic idle timeout and deactivation
          - eBPF-based traffic monitoring for minimal overhead
          - NetworkManager integration
         .
         This package contains statically-linked binaries that work on any
         Linux distribution without additional dependencies.
        Homepage: https://github.com/vly/wg-ondemand
        EOF

        # Create postinst script
        cat > ${DEB_DIR}/DEBIAN/postinst << 'EOF'
        #!/bin/bash
        set -e

        # Reload systemd
        if [ -d /run/systemd/system ]; then
            systemctl daemon-reload >/dev/null 2>&1 || true
        fi

        # Create config if it doesn't exist
        if [ ! -f /etc/wg-ondemand/config.toml ]; then
            if [ -f /etc/wg-ondemand/wg-ondemand.toml.example ]; then
                echo "Creating default config at /etc/wg-ondemand/config.toml"
                cp /etc/wg-ondemand/wg-ondemand.toml.example /etc/wg-ondemand/config.toml
                echo "Please edit /etc/wg-ondemand/config.toml before starting the service"
            fi
        fi

        exit 0
        EOF

        # Create prerm script
        cat > ${DEB_DIR}/DEBIAN/prerm << 'EOF'
        #!/bin/bash
        set -e

        # Stop and disable service
        if [ -d /run/systemd/system ]; then
            systemctl stop wg-ondemand.service >/dev/null 2>&1 || true
            systemctl disable wg-ondemand.service >/dev/null 2>&1 || true
        fi

        exit 0
        EOF

        # Create postrm script
        cat > ${DEB_DIR}/DEBIAN/postrm << 'EOF'
        #!/bin/bash
        set -e

        # Reload systemd
        if [ "$1" = "remove" ] && [ -d /run/systemd/system ]; then
            systemctl daemon-reload >/dev/null 2>&1 || true
        fi

        exit 0
        EOF

        # Make scripts executable
        chmod 755 ${DEB_DIR}/DEBIAN/postinst
        chmod 755 ${DEB_DIR}/DEBIAN/prerm
        chmod 755 ${DEB_DIR}/DEBIAN/postrm

        # Build the package
        dpkg-deb --build --root-owner-group ${DEB_DIR}

        # Create checksum
        sha256sum ${DEB_DIR}.deb > ${DEB_DIR}.deb.sha256

        echo "✓ Debian package built: ${DEB_DIR}.deb"

    - name: Upload release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wg-ondemand-${{ steps.version.outputs.VERSION }}
        path: |
          wg-ondemand-*.tar.gz
          wg-ondemand-*.tar.gz.sha256
          wg-ondemand_*.deb
          wg-ondemand_*.deb.sha256

    - name: Create GitHub Release
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          wg-ondemand-*.tar.gz
          wg-ondemand-*.tar.gz.sha256
          wg-ondemand_*.deb
          wg-ondemand_*.deb.sha256
        body: |
          # WireGuard On-Demand ${{ steps.version.outputs.VERSION }}

          Automatic VPN activation when you need it, idle when you don't.

          ## Installation

          ### Debian/Ubuntu (.deb package)
          ```bash
          # Download the .deb file from the Assets section below, then:
          sudo dpkg -i wg-ondemand_*_amd64.deb

          # Configure
          sudo nano /etc/wg-ondemand/config.toml

          # Start service
          sudo systemctl enable wg-ondemand
          sudo systemctl start wg-ondemand
          ```

          ### Manual Installation (tarball)
          ```bash
          # Download and extract
          tar xzf wg-ondemand-${{ steps.version.outputs.VERSION }}.tar.gz
          cd wg-ondemand-${{ steps.version.outputs.VERSION }}/

          # Install (requires sudo)
          sudo ./install.sh

          # Configure
          sudo nano /etc/wg-ondemand/config.toml

          # Start service
          sudo systemctl enable wg-ondemand
          sudo systemctl start wg-ondemand
          ```

          ## What's Included

          - **Debian package (.deb)** - Easy installation for Debian/Ubuntu
          - **Tarball** - Manual installation for any distro
          - Statically-linked binaries for x86_64 Linux (works on any distro)
          - Installation and uninstallation scripts
          - Systemd service file
          - Example configuration
          - Documentation

          ## Requirements

          - Linux kernel 5.8+
          - NetworkManager
          - WireGuard

          **Note:** Binaries are statically linked with musl and work on any Linux distribution without additional dependencies or SELinux configuration.

          See `INSTALL.md` in the archive for detailed instructions.

          ## Performance Improvements

          This release includes significant battery and resource optimizations:
          - 89% reduction in CPU wakeups (88.5K/day → <10K/day)
          - 50-120MB memory savings
          - 100x faster stats checking via netlink API
          - Optimized eBPF ring buffer usage
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
