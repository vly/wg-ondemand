#!/usr/bin/env bash
# wg-ondemand-ctl - Control script for WireGuard On-Demand daemon

set -e

SERVICE_NAME="wg-ondemand"
CONFIG_PATH="/etc/wg-ondemand/config.toml"
INSTALL_SCRIPT="/usr/local/share/wg-ondemand/install.sh"
UNINSTALL_SCRIPT="/usr/local/share/wg-ondemand/uninstall.sh"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

error() {
    echo -e "${RED}Error:${NC} $1" >&2
    exit 1
}

success() {
    echo -e "${GREEN}✓${NC} $1"
}

info() {
    echo -e "${YELLOW}→${NC} $1"
}

check_root() {
    if [[ $EUID -ne 0 ]]; then
        error "This command requires root privileges. Run with sudo."
    fi
}

cmd_status() {
    # Determine service state
    local status=""
    if systemctl is-active --quiet "$SERVICE_NAME"; then
        status="active"
    elif systemctl is-enabled --quiet "$SERVICE_NAME" 2>/dev/null; then
        status="inactive"
    else
        status="disabled"
    fi

    # Get tunnel state from logs if service is active
    local tunnel_state="unknown"
    local ssid=""

    if [[ "$status" == "active" ]]; then
        local logs=$(journalctl -u "$SERVICE_NAME" -n 50 --no-pager 2>/dev/null || echo "")

        # Check for tunnel activation (highest priority - means VPN is connected)
        if echo "$logs" | grep -q "Tunnel activated successfully"; then
            tunnel_state="connected"
        # Check for active monitoring on target SSID
        elif echo "$logs" | grep -q "Connected to monitored SSID:"; then
            tunnel_state="monitoring"
        # If service is running but no active state, it's idle
        else
            tunnel_state="idle"
        fi

        # Extract SSID if monitoring
        ssid=$(echo "$logs" | grep -o "Connected to monitored SSID: [^\"]*" | tail -1 | cut -d: -f2- | xargs)
    fi

    # Output JSON if --json flag is present
    if [[ "$1" == "--json" ]]; then
        cat << EOF
{
    "service_status": "$status",
    "tunnel_state": "$tunnel_state",
    "ssid": "$ssid"
}
EOF
        return
    fi

    # Human-readable output
    echo "=== WireGuard On-Demand Status ==="
    echo

    # Service status
    if [[ "$status" == "active" ]]; then
        echo -e "Service: ${GREEN}running${NC}"
    else
        echo -e "Service: ${RED}stopped${NC}"
    fi

    if systemctl is-enabled --quiet "$SERVICE_NAME" 2>/dev/null; then
        echo -e "Enabled: ${GREEN}yes${NC}"
    else
        echo -e "Enabled: ${YELLOW}no${NC}"
    fi

    echo

    # Recent logs
    echo "=== Recent Logs ==="
    journalctl -u "$SERVICE_NAME" -n 10 --no-pager 2>/dev/null || echo "No logs available"
}

cmd_start() {
    check_root
    info "Starting $SERVICE_NAME..."
    systemctl start "$SERVICE_NAME"
    success "Service started"

    sleep 1
    if systemctl is-active --quiet "$SERVICE_NAME"; then
        success "Service is running"
    else
        error "Service failed to start. Check: journalctl -u $SERVICE_NAME"
    fi
}

cmd_stop() {
    check_root
    info "Stopping $SERVICE_NAME..."
    systemctl stop "$SERVICE_NAME"
    success "Service stopped"
}

cmd_restart() {
    check_root
    info "Restarting $SERVICE_NAME..."
    systemctl restart "$SERVICE_NAME"
    success "Service restarted"

    sleep 1
    if systemctl is-active --quiet "$SERVICE_NAME"; then
        success "Service is running"
    else
        error "Service failed to restart. Check: journalctl -u $SERVICE_NAME"
    fi
}

cmd_enable() {
    check_root
    info "Enabling $SERVICE_NAME to start on boot..."
    systemctl enable "$SERVICE_NAME"
    success "Service enabled"
}

cmd_disable() {
    check_root
    info "Disabling $SERVICE_NAME from starting on boot..."
    systemctl disable "$SERVICE_NAME"
    success "Service disabled"
}

cmd_logs() {
    local follow=""
    if [[ "$1" == "-f" || "$1" == "--follow" ]]; then
        follow="-f"
    fi

    echo "=== Logs (press Ctrl+C to exit) ==="
    journalctl -u "$SERVICE_NAME" $follow
}

cmd_config() {
    if [[ ! -f "$CONFIG_PATH" ]]; then
        error "Config file not found at $CONFIG_PATH"
    fi

    if [[ "$1" == "edit" ]]; then
        check_root
        "${EDITOR:-nano}" "$CONFIG_PATH"
        info "Config edited. Restart service to apply: wg-ondemand-ctl restart"
    else
        cat "$CONFIG_PATH"
    fi
}

cmd_install() {
    check_root
    if [[ -f "$INSTALL_SCRIPT" ]]; then
        info "Running installation script..."
        "$INSTALL_SCRIPT"
    else
        error "Install script not found at $INSTALL_SCRIPT"
    fi
}

cmd_uninstall() {
    check_root
    echo -e "${YELLOW}Warning:${NC} This will remove wg-ondemand and its configuration."
    read -p "Are you sure? [y/N] " -n 1 -r
    echo

    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Cancelled."
        exit 0
    fi

    if [[ -f "$UNINSTALL_SCRIPT" ]]; then
        info "Running uninstall script..."
        "$UNINSTALL_SCRIPT"
    else
        error "Uninstall script not found at $UNINSTALL_SCRIPT"
    fi
}

cmd_version() {
    if command -v wg-ondemand >/dev/null 2>&1; then
        wg-ondemand --version 2>/dev/null || echo "wg-ondemand (version unknown)"
    else
        error "wg-ondemand binary not found"
    fi
}

show_usage() {
    cat <<EOF
wg-ondemand-ctl - WireGuard On-Demand control utility

Usage: wg-ondemand-ctl <command> [options]

Commands:
  status [--json]     Show service status and recent logs (--json for machine-readable output)
  start               Start the daemon (requires sudo)
  stop                Stop the daemon (requires sudo)
  restart             Restart the daemon (requires sudo)
  enable              Enable service to start on boot (requires sudo)
  disable             Disable service from starting on boot (requires sudo)
  logs [-f]           Show logs (use -f to follow)
  config [edit]       Show config, or edit with 'config edit' (requires sudo)
  install             Run installation (requires sudo)
  uninstall           Remove wg-ondemand (requires sudo)
  version             Show version information

Examples:
  wg-ondemand-ctl status
  wg-ondemand-ctl status --json
  sudo wg-ondemand-ctl restart
  wg-ondemand-ctl logs -f
  sudo wg-ondemand-ctl config edit

EOF
}

# Main command dispatcher
case "${1:-}" in
    status)
        shift
        cmd_status "$@"
        ;;
    start)
        cmd_start
        ;;
    stop)
        cmd_stop
        ;;
    restart)
        cmd_restart
        ;;
    enable)
        cmd_enable
        ;;
    disable)
        cmd_disable
        ;;
    logs)
        shift
        cmd_logs "$@"
        ;;
    config)
        shift
        cmd_config "$@"
        ;;
    install)
        cmd_install
        ;;
    uninstall)
        cmd_uninstall
        ;;
    version)
        cmd_version
        ;;
    -h|--help|help)
        show_usage
        ;;
    "")
        show_usage
        exit 1
        ;;
    *)
        error "Unknown command: $1\n\nRun 'wg-ondemand-ctl help' for usage."
        ;;
esac
